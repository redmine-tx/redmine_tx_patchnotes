<div class="container">
  <div class="section">
    <h3 class="title">패치노트 설정</h3>
    <div class="info-box">
      패치노트 작성이 필요한 일감 유형은 <a href="<%= trackers_path %>">관리 > 일감 유형</a>에서 각 유형의 <strong>패치노트</strong> 속성을 설정하세요.
    </div>
    <div class="grid">
      <div class="item">
        <h3>패치노트가 작성 완료된 일감의 상태</h3>
        <div class="select-wrapper">
          <%= select_tag('settings_redmine_tx_patchnotes_complete',
              options_for_select(IssueStatus.all.map { |s| [s.name, s.id] },
                selected: Setting[:plugin_redmine_tx_patchnotes][:complete].to_s.tr('[]" ','').split(',').map {|i| i.to_i}),
              name: 'settings[complete][]',
              multiple: true) %>
        </div>
      </div>

      <div class="item">
        <h3>미대상 유형도 패치노트 기재 허용</h3>
        <div class="checkbox-wrapper">
          <%= check_box_tag 'settings[allow_non_target_tracker]', '1',
              Setting[:plugin_redmine_tx_patchnotes][:allow_non_target_tracker] == '1' %>
          <span>대상 유형이 아닌 일감에서도 패치노트 작성 가능</span>
        </div>
        <div class="item-desc">
          활성화하면 모든 유형의 일감에 패치노트 섹션이 표시되고, 작성된 패치노트는 목록에 취합됩니다.</div>
      </div>

      <div class="item">
        <h3>다중 패치노트 기입 허용</h3>
        <div class="checkbox-wrapper">
          <%= check_box_tag 'settings[allow_multiple_parts]', '1',
              Setting[:plugin_redmine_tx_patchnotes][:allow_multiple_parts] == '1' %>
          <span>한 일감에 여러 파트의 패치노트 기입 허용</span>
        </div>
        <div class="item-desc">
          비활성화하면 일감 당 하나의 패치노트만 작성 가능합니다.</div>
      </div>

      <div class="item">
        <h3>텍스트 헤더 자동 DB 동기화</h3>
        <div class="checkbox-wrapper">
          <%= check_box_tag 'settings[auto_sync_text_to_db]', '1',
              Setting[:plugin_redmine_tx_patchnotes][:auto_sync_text_to_db] == '1' %>
          <span>본문/코멘트에 PATCH_NOTE 헤더 작성 시 자동으로 DB에 기입</span>
        </div>
        <div class="item-desc">
          활성화하면 기존 방식대로 헤더를 작성해도 DB 패치노트가 자동 생성됩니다.
          이미 DB에 동일 파트의 패치노트가 있는 일감은 건너뜁니다.</div>
      </div>

      <div class="item">
        <h3>패치노트 헤더 <span style="color: #999; font-size: 0.8em;">(레거시 - 마이그레이션용)</span></h3>
        <div class="input-wrapper">
          <%= text_field_tag 'settings[patch_note_header]',
              Setting[:plugin_redmine_tx_patchnotes][:patch_note_header],
              class: 'full-width', disabled: true %>
          <div class="item-desc">DB 전환 후 텍스트 마이그레이션에만 사용됩니다.</div>
        </div>
      </div>

      <div class="item">
        <h3>패치노트 스킵 헤더 <span style="color: #999; font-size: 0.8em;">(레거시 - 마이그레이션용)</span></h3>
        <div class="input-wrapper">
          <%= text_field_tag 'settings[patch_skip_header]',
              Setting[:plugin_redmine_tx_patchnotes][:patch_skip_header],
              class: 'full-width', disabled: true %>
          <div class="item-desc">DB 전환 후 텍스트 마이그레이션에만 사용됩니다.</div>
        </div>
      </div>

      <div class="item">
        <h3>패치노트 업어도 되는 태그</h3>
        <div class="input-wrapper">
          <%= text_field_tag 'settings[patch_skip_tag]',
              Setting[:plugin_redmine_tx_patchnotes][:patch_skip_tag],
              class: 'full-width' %>
        </div>
      </div>

      <div class="item">
        <h3>패치노트 유형 순서</h3>
        <div class="tracker-order-wrapper">
          <div class="tracker-order-list" id="tracker-order-list">
            <%
              tracker_order = Setting[:plugin_redmine_tx_patchnotes][:tracker_order]
              tracker_order = tracker_order.to_s.tr('[]" ','').split(',').map {|i| i.to_i} if tracker_order.present?
              tracker_order = [] if tracker_order.blank?

              # is_patchnote 플래그가 설정된 유형만 필터링
              patchnote_trackers = Tracker.where(is_patchnote: true)

              # 순서가 설정된 트래커들을 먼저 표시
              ordered_trackers = tracker_order.map { |id| patchnote_trackers.find { |t| t.id == id } }.compact
              remaining_trackers = patchnote_trackers.order(:name) - ordered_trackers
              all_trackers = ordered_trackers + remaining_trackers
            %>
            
            <% all_trackers.each do |tracker| %>
              <div class="tracker-order-item" data-tracker-id="<%= tracker.id %>">
                <div class="drag-handle">⋮⋮</div>
                <span class="tracker-name"><%= tracker.name %></span>
              </div>
            <% end %>
          </div>
          <input type="hidden" id="tracker-order-input" name="settings[tracker_order][]" value="">
        </div>
      </div>
      
    </div>
  </div>
</div>

<style>
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.section {
  background: #fff;
  padding: 20px;
  margin-bottom: 20px;
}

.title {
  color: #2c3e50;
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.info-box {
  background: #f0f7ff;
  border: 1px solid #b8d4f0;
  border-radius: 4px;
  padding: 10px 14px;
  margin-bottom: 20px;
  color: #2c5282;
  font-size: 0.93em;
}

.info-box a {
  color: #2b6cb0;
  font-weight: 500;
}

.grid {
  display: grid;
  gap: 20px;
}

.item h3 {
  color: #555;
  margin-bottom: 10px;
}

.item-desc {
  color: #999;
  font-size: 0.85em;
  margin-top: 4px;
}

.select-wrapper {
  width: 100%;
}

.input-wrapper {
  width: 100%;
}

.full-width {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  }
}

.tracker-order-wrapper {
  width: 100%;
}

.tracker-order-list {
  border: 1px solid #ddd;
  border-radius: 4px;
  background: #f9f9f9;
  padding: 10px;
  min-height: 100px;
}

.tracker-order-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  margin: 4px 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: move;
  transition: background-color 0.2s;
}

.tracker-order-item:hover {
  background: #f5f5f5;
}

.tracker-order-item.dragging {
  opacity: 0.5;
}

.drag-handle {
  margin-right: 10px;
  color: #999;
  cursor: grab;
}

.tracker-name {
  flex-grow: 1;
  font-weight: 500;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const trackerOrderList = document.getElementById('tracker-order-list');
  const trackerOrderInput = document.getElementById('tracker-order-input');

  // 현재 순서를 input에 저장
  function updateTrackerOrder() {
    const items = trackerOrderList.querySelectorAll('.tracker-order-item');
    const order = Array.from(items).map(item => item.dataset.trackerId);
    trackerOrderInput.value = order.join(',');
  }

  // 초기 순서 설정
  updateTrackerOrder();

  // 드래그 앤 드롭 기능
  let draggedItem = null;

  trackerOrderList.addEventListener('dragstart', function(e) {
    if (e.target.classList.contains('tracker-order-item')) {
      draggedItem = e.target;
      e.target.classList.add('dragging');
    }
  });

  trackerOrderList.addEventListener('dragend', function(e) {
    if (e.target.classList.contains('tracker-order-item')) {
      e.target.classList.remove('dragging');
      draggedItem = null;
    }
  });

  trackerOrderList.addEventListener('dragover', function(e) {
    e.preventDefault();
    const afterElement = getDragAfterElement(trackerOrderList, e.clientY);
    if (afterElement == null) {
      trackerOrderList.appendChild(draggedItem);
    } else {
      trackerOrderList.insertBefore(draggedItem, afterElement);
    }
    updateTrackerOrder();
  });

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.tracker-order-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;

      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // 모든 tracker-order-item에 draggable 속성 추가
  document.querySelectorAll('.tracker-order-item').forEach(item => {
    item.setAttribute('draggable', true);
  });
});
</script>

