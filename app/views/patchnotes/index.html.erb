<% content_for :header_tags do %>
    <%= stylesheet_link_tag 'context_menu' %>
    <%= javascript_include_tag 'context_menu' %>
    <%= stylesheet_link_tag 'scm' %>
    <%= stylesheet_link_tag 'wiki' %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<% end %>

<style>
    .version-box {
        border: 1px solid #999;
        padding: 10px;
        margin: 10px;
        border-radius: 8px;
    }
    .note-item {
        margin-bottom: 10px;
    }
    .note-item-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .note-item-content {
        opacity: 0.6;
    }

    /* μ»¨ν…μΈ  νƒ­ μ¤νƒ€μΌ μμ • */
    .content-tabs {
        margin: 20px 0;
    }

    .content-tabs ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border-bottom: 1px solid #ccc;
        height: auto;  /* κΈ°μ΅΄ Redmine νƒ­μ height μ„¤μ • μ κ±° */
    }

    .content-tabs li {
        display: inline-block;
        margin-right: 5px;
        float: none;  /* κΈ°μ΅΄ Redmine νƒ­μ float μ κ±° */
    }

    .content-tabs a {
        display: inline-block;
        padding: 8px 15px;
        text-decoration: none;
        border: 1px solid #ccc;
        border-radius: 3px 3px 0 0;
        background-color: #f6f6f6;
        margin-bottom: -1px;
    }

    .content-tabs a.active {
        background: #fff;
        border-bottom-color: #fff;
        color: #555;
    }

    /* νƒ­ μ»¨ν…μΈ  μ¤νƒ€μΌ */
    .tab-content > div {
        display: none;
    }
    
    .tab-content > div.active {
        display: block;
    }
</style>

<div class="tabs" style="height: 48px;">
    <ul>
        <% @versions.each do |version| %>
            <li><%= link_to version.name.to_s, '?version_id=' + version.id.to_s, class: @selected_version.id == version.id ? 'selected' : '' %></li>
        <% end %>
    </ul>
</div>

<div class="content-tabs">
    <ul>
        <li><a href="?version_id=<%= @selected_version.id %>&tab=1" class="tab-link <%= params[:tab].nil? || params[:tab] == '1' ? 'active' : '' %>" data-tab="inner-tab-1">ν¨μΉλ…ΈνΈ (κ³µκ°: <%= @public_notes.count %> / λ‚΄λ¶€: <%= @internal_notes.count %>)</a></li>
        <li><a href="?version_id=<%= @selected_version.id %>&tab=2" class="tab-link <%= params[:tab] == '2' ? 'active' : '' %>" data-tab="inner-tab-2">ν¨μΉλ…ΈνΈ μ‘μ„± μ™„λ£ μΌκ° (<%= @issues_patch_note_complete.count %>)</a></li>
        <li><a href="?version_id=<%= @selected_version.id %>&tab=3" class="tab-link <%= params[:tab] == '3' ? 'active' : '' %>" data-tab="inner-tab-3">ν¨μΉλ…ΈνΈ μ‘μ„± μμ™Έ μΌκ° (<%= @no_patch_note_issues.count %>)</a></li>
        <li><a href="?version_id=<%= @selected_version.id %>&tab=4" class="tab-link <%= params[:tab] == '4' ? 'active' : '' %>" data-tab="inner-tab-4">ν¨μΉλ…ΈνΈ λ„λ½ μΌκ° (<%= @issues_need_patch_notes.count %>)</a></li>
        <li><a href="?version_id=<%= @selected_version.id %>&tab=5" class="tab-link <%= params[:tab] == '5' ? 'active' : '' %>" data-tab="inner-tab-5">ν¨μΉλ…ΈνΈ κΈ°μ¬ μ—†μ΄ μ™„λ£ μ²λ¦¬λ μΌκ° (<%= @issues_complete_without_patch_notes.count %>)</a></li>
    </ul>
</div>

<%
    def render_issues_list(issues, project)
        query = IssueQuery.new(name: 'ν¨μΉλ…ΈνΈ λ„λ½ μΌκ°')
        query.project = project
        query.column_names = [:id, :tracker,:status, :priority, :subject, :assigned_to, :done_ratio, :due_date]
        query.sort_criteria = params[:sort] if params[:sort].present?
        
        render partial: 'issues/list', 
            locals: { 
                query: query, 
                issues: issues, 
                context_menu: true
            }
    end
%>

<div class="tab-content">
    <% if params[:tab].nil? || params[:tab] == '1' %>

        <div class="inner-tab-1 active">

        <!-- κ³µκ°μ© ν¨μΉλ…ΈνΈ -->
        <% if @public_notes.any? %>
            <h2 style="margin-top: 20px; margin-bottom: 10px; color: #169; border-bottom: 2px solid #169; padding-bottom: 5px;">
                π“Ά κ³µκ°μ© ν¨μΉλ…ΈνΈ
            </h2>

            <% @public_notes_by_part.each do |part, notes| %>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">ν¨μΉλ…ΈνΈ #<%= part %></h3>
                    <div style="display: flex; gap: 10px;">
                        <a href="#" onclick="exportPatchNotesToExcel(<%= part %>, 'public'); return false;" class="icon icon-download button">
                            μ—‘μ…€ λ‹¤μ΄λ΅λ“
                        </a>
                        <a href="#" onclick="copyPatchNotes(<%= part %>, 'public'); return false;" class="icon icon-copy button">
                            ν΄λ¦½λ³΄λ“μ— λ³µμ‚¬ν•κΈ°
                        </a>
                    </div>
                </div>
                <div class="version-box">
                    <ul class="patch-notes-list-public-<%= part %>" id="patch-notes-list-public-<%= part %>">
                        <% notes.each do |note| %>
                            <%
                                worker_name = if note[:issue].worker_id.present?
                                    u = User.where(id: note[:issue].worker_id).first
                                    u.present? ? u.name : note[:issue].assigned_to.name
                                else
                                    note[:issue].assigned_to.name
                                end
                            %>
                            <li class="note-item"
                                data-issue-id="<%= note[:issue].id %>"
                                data-issue-url="<%= issue_url(note[:issue]) %>"
                                data-tracker="<%= note[:issue].tracker.name %>"
                                data-category="<%= note[:issue].category.present? ? note[:issue].category.name : '' %>"
                                data-status="<%= note[:issue].status.name %>"
                                data-priority="<%= note[:issue].priority.name %>"
                                data-done-ratio="<%= note[:issue].done_ratio %>"
                                data-assignee="<%= worker_name.gsub(/ /, '') %>">
                                <strong class="note-item-title">
                                    <%= note[:issue].subject %> <%= link_to "#" + note[:issue].id.to_s, issue_path(note[:issue]) %>
                                </strong> <span style="font-size: 0.8em; color: #666;">(λ‹΄λ‹Ήμ: <%= worker_name.gsub(/ /, '') %>)</span>
                                <div class="note-item-content wiki">
                                    <%= textilizable(note[:notes], :object => note[:issue]) %>
                                </div>
                            </li>
                        <% end %>
                    </ul>
                </div>

            <% end %>
        <% end %>

        <!-- λ‚΄λ¶€ μ°Έμ΅°μ© ν¨μΉλ…ΈνΈ -->
        <% if @internal_notes.any? %>
            <h2 style="margin-top: 40px; margin-bottom: 10px; color: #d63; border-bottom: 2px solid #d63; padding-bottom: 5px;">
                π”’ λ‚΄λ¶€ μ°Έμ΅°μ© ν¨μΉλ…ΈνΈ (μ΄μμ μ „μ©)
            </h2>
            <p style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 4px; color: #856404; margin-bottom: 15px;">
                β οΈ μ΄ μ„Ήμ…μ ν¨μΉλ…ΈνΈλ” μ μ € κ³µκ°μ© ν¨μΉλ…ΈνΈμ— ν¬ν•¨λμ§€ μ•μµλ‹λ‹¤.
            </p>

            <% @internal_notes_by_part.each do |part, notes| %>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">λ‚΄λ¶€ ν¨μΉλ…ΈνΈ #<%= part %></h3>
                    <div style="display: flex; gap: 10px;">
                        <a href="#" onclick="exportPatchNotesToExcel(<%= part %>, 'internal'); return false;" class="icon icon-download button">
                            μ—‘μ…€ λ‹¤μ΄λ΅λ“
                        </a>
                        <a href="#" onclick="copyPatchNotes(<%= part %>, 'internal'); return false;" class="icon icon-copy button">
                            ν΄λ¦½λ³΄λ“μ— λ³µμ‚¬ν•κΈ°
                        </a>
                    </div>
                </div>
                <div class="version-box" style="border-color: #d63;">
                    <ul class="patch-notes-list-internal-<%= part %>" id="patch-notes-list-internal-<%= part %>">
                        <% notes.each do |note| %>
                            <%
                                worker_name = if note[:issue].worker_id.present?
                                    u = User.where(id: note[:issue].worker_id).first
                                    u.present? ? u.name : note[:issue].assigned_to.name
                                else
                                    note[:issue].assigned_to.name
                                end
                            %>
                            <li class="note-item"
                                data-issue-id="<%= note[:issue].id %>"
                                data-issue-url="<%= issue_url(note[:issue]) %>"
                                data-tracker="<%= note[:issue].tracker.name %>"
                                data-category="<%= note[:issue].category.present? ? note[:issue].category.name : '' %>"
                                data-status="<%= note[:issue].status.name %>"
                                data-priority="<%= note[:issue].priority.name %>"
                                data-done-ratio="<%= note[:issue].done_ratio %>"
                                data-assignee="<%= worker_name.gsub(/ /, '') %>">
                                <strong class="note-item-title">
                                    <%= note[:issue].subject %> <%= link_to "#" + note[:issue].id.to_s, issue_path(note[:issue]) %>
                                </strong> <span style="font-size: 0.8em; color: #666;">(λ‹΄λ‹Ήμ: <%= worker_name.gsub(/ /, '') %>)</span>
                                <div class="note-item-content wiki">
                                    <%= textilizable(note[:notes], :object => note[:issue]) %>
                                </div>
                            </li>
                        <% end %>
                    </ul>
                </div>

            <% end %>
        <% end %>

        </div>
    <% end %>

    <% if params[:tab] == '2' %>
        <div class="inner-tab-2 active">
            <h3>ν¨μΉλ…ΈνΈ μ‘μ„± μ™„λ£ μΌκ°</h3>
            <div class="version-box">
                <%= render_issues_list(@issues_patch_note_complete, @project) %>
            </div>
        </div>
    <% end %>

    <% if params[:tab] == '3' %>
        <div class="inner-tab-3 active">
            <h3>ν¨μΉλ…ΈνΈ μ‘μ„± μμ™Έ μΌκ°</h3>
            <div class="version-box">
                <%= render_issues_list(@no_patch_note_issues, @project) %>
            </div>
        </div>
    <% end %>

    <% if params[:tab] == '4' %>
        <div class="inner-tab-4 active">
            <h3>ν¨μΉλ…ΈνΈ λ„λ½ μΌκ°</h3>
            <div class="version-box">
                <%= render_issues_list(@issues_need_patch_notes, @project) %>
            </div>
        </div>
    <% end %>

    <% if params[:tab] == '5' %>
        <div class="inner-tab-5 active">
            <h3>ν¨μΉλ…ΈνΈ κΈ°μ¬ μ—†μ΄ μ™„λ£ μ²λ¦¬λ μΌκ°</h3>
            <div class="version-box">
                <%= render_issues_list(@issues_complete_without_patch_notes, @project) %>
            </div>
        </div>
    <% end %>
</div>

<%= context_menu %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabLinks = document.querySelectorAll('.tab-link');

    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // νƒ­ ν΄λ¦­ μ‹ νμ΄μ§€ μ΄λ™μ΄ λλ―€λ΅ μ΄λ²¤νΈ μ²λ¦¬λ” μ κ±°
            // e.preventDefault();
            // ... κΈ°μ΅΄ νƒ­ μ „ν™ μ½”λ“ μ κ±° ...
        });
    });
});

// HTMLμ„ Plain Textλ΅ λ³€ν™ν•λ” ν•¨μ
function htmlToPlainText(html) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // μ¤„λ°”κΏ μ²λ¦¬: <br>, <p>, <div> λ“±μ„ μ¤„λ°”κΏμΌλ΅ λ³€ν™
    tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
    tempDiv.querySelectorAll('p, div, li').forEach(el => {
        el.appendChild(document.createTextNode('\n'));
    });

    // ν…μ¤νΈλ§ μ¶”μ¶
    return tempDiv.textContent || tempDiv.innerText || '';
}

// μ—‘μ…€ λ‹¤μ΄λ΅λ“ ν•¨μ
async function exportPatchNotesToExcel(part = 1, type = 'public') {
    const listId = type === 'internal' ?
        'patch-notes-list-internal-' + part :
        'patch-notes-list-public-' + part;
    const patchNotesList = document.getElementById(listId);

    if (!patchNotesList) {
        alert('ν¨μΉλ…ΈνΈ λ©λ΅μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤.');
        return;
    }

    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('ν¨μΉλ…ΈνΈ');

        // ν—¤λ” μ„¤μ •
        worksheet.columns = [
            { header: 'ID', key: 'id', width: 10 },
            { header: 'μ ν•', key: 'tracker', width: 12 },
            { header: 'λ²”μ£Ό', key: 'category', width: 15 },
            { header: 'μ λ©', key: 'subject', width: 40 },
            { header: 'λ””ν…μΌ', key: 'detail', width: 60 },
            { header: 'λ‹΄λ‹Ήμ', key: 'assignee', width: 15 },
            { header: 'μƒνƒ', key: 'status', width: 12 },
            { header: 'μ°μ„ μμ„', key: 'priority', width: 12 },
            { header: 'μ§„ν–‰μ¨', key: 'done_ratio', width: 10 }
        ];

        // ν—¤λ” μ¤νƒ€μΌ μ„¤μ •
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE0E0E0' }
        };

        // κ° ν¨μΉλ…ΈνΈ ν•­λ© μ¶”κ°€
        const items = patchNotesList.getElementsByClassName('note-item');
        Array.from(items).forEach((item, index) => {
            const titleElement = item.querySelector('.note-item-title');
            const contentElement = item.querySelector('.note-item-content');

            // data attributeμ—μ„ μ •λ³΄ κ°€μ Έμ¤κΈ°
            const issueId = item.dataset.issueId || '';
            const issueUrl = item.dataset.issueUrl || '';
            const tracker = item.dataset.tracker || '';
            const category = item.dataset.category || '';
            const status = item.dataset.status || '';
            const priority = item.dataset.priority || '';
            const doneRatio = item.dataset.doneRatio || '0';
            const assignee = item.dataset.assignee || '';

            // μ λ© μ¶”μ¶ (μΌκ° λ²νΈμ™€ λ‹΄λ‹Ήμ μ •λ³΄ μ μ™Έ)
            const titleText = titleElement.textContent.trim();
            const subject = titleText
                .replace(/#\d+/, '')  // #μ«μ μ κ±°
                .replace(/\(λ‹΄λ‹Ήμ:.*?\)/, '')  // λ‹΄λ‹Ήμ μ •λ³΄ μ κ±°
                .trim();

            // HTMLμ„ Plain Textλ΅ λ³€ν™
            const detail = htmlToPlainText(contentElement.innerHTML);

            // ν–‰ μ¶”κ°€
            const row = worksheet.addRow({
                id: issueId,
                tracker: tracker,
                category: category,
                subject: subject,
                detail: detail.trim(),
                assignee: assignee,
                status: status,
                priority: priority,
                done_ratio: doneRatio + '%'
            });

            // ID μ»¬λΌμ— ν•μ΄νΌλ§ν¬ μ¶”κ°€
            if (issueUrl) {
                row.getCell('id').value = {
                    text: issueId,
                    hyperlink: issueUrl,
                    tooltip: 'μΌκ° λ³΄κΈ°'
                };
                row.getCell('id').font = { color: { argb: 'FF0066CC' }, underline: true };
            }

            // λ””ν…μΌ μ…€ μ¤„λ°”κΏ μ„¤μ •
            row.getCell('detail').alignment = { wrapText: true, vertical: 'top' };

            // λ¨λ“  μ…€ μ„Έλ΅ μ •λ ¬μ„ μƒλ‹¨μΌλ΅
            row.eachCell((cell) => {
                if (!cell.alignment) cell.alignment = {};
                cell.alignment.vertical = 'top';
            });
        });

        // νμΌλ… μƒμ„±
        const versionName = '<%= @selected_version.name %>';
        const typeLabel = type === 'internal' ? 'λ‚΄λ¶€μ©' : 'κ³µκ°μ©';
        const fileName = `ν¨μΉλ…ΈνΈ_${versionName}_Part${part}_${typeLabel}.xlsx`;

        // μ—‘μ…€ νμΌ μƒμ„± λ° λ‹¤μ΄λ΅λ“
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);

        alert('μ—‘μ…€ νμΌμ΄ λ‹¤μ΄λ΅λ“λμ—μµλ‹λ‹¤.');
    } catch (error) {
        console.error('μ—‘μ…€ μƒμ„± μ‹¤ν¨:', error);
        alert('μ—‘μ…€ μƒμ„± μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤: ' + error.message);
    }
}

function copyPatchNotes(part = 1, type = 'public') {
    const listId = type === 'internal' ?
        'patch-notes-list-internal-' + part :
        'patch-notes-list-public-' + part;
    const patchNotesList = document.getElementById(listId);

    if (!patchNotesList) {
        alert('ν¨μΉλ…ΈνΈ λ©λ΅μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤.');
        return;
    }

    const items = patchNotesList.getElementsByClassName('note-item');
    
    // μ„μ‹ div μƒμ„±
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'fixed';
    tempDiv.style.opacity = '0';
    tempDiv.style.pointerEvents = 'none';
    
    // μ΄λ―Έμ§€λ¥Ό λ°μ΄ν„° URLλ΅ λ³€ν™ν•λ” ν•¨μ
    async function convertImageToDataURL(imgUrl) {
        try {
            const response = await fetch(imgUrl);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (err) {
            console.error('μ΄λ―Έμ§€ λ³€ν™ μ‹¤ν¨:', err);
            return imgUrl;
        }
    }

    // κ° ν•­λ©μ HTMLμ„ λ³µμ‚¬
    Promise.all(Array.from(items).map(async item => {
        const title = item.querySelector('.note-item-title').innerHTML;
        let content = item.querySelector('.note-item-content').innerHTML;
        
        // μ΄λ―Έμ§€ URLμ„ μ λ€ κ²½λ΅λ΅ λ³€ν™ν•κ³  λ°μ΄ν„° URLλ΅ λ³€ν™
        const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
        const imgPromises = [];
        content = content.replace(imgRegex, (match, src) => {
            const absoluteSrc = src.startsWith('http') ? src : `${window.location.origin}${src}`;
            imgPromises.push(
                convertImageToDataURL(absoluteSrc).then(dataUrl => {
                    return match.replace(src, dataUrl);
                })
            );
            return match;
        });

        // λ¨λ“  μ΄λ―Έμ§€ λ³€ν™μ΄ μ™„λ£λ  λ•κΉμ§€ λ€κΈ°
        if (imgPromises.length > 0) {
            const results = await Promise.all(imgPromises);
            results.forEach((replacedImg, index) => {
                content = content.replace(imgRegex, (match, src) => {
                    if (index === 0) return replacedImg;
                    return match;
                });
            });
        }
        
        return `<div class="note-item">
            <strong class="note-item-title">${title}</strong>
            <div class="note-item-content">${content}</div>
        </div>`;
    })).then(htmlContents => {
        tempDiv.innerHTML = htmlContents.join('');
        document.body.appendChild(tempDiv);
        
        // HTML μ„ νƒ λ° λ³µμ‚¬
        const range = document.createRange();
        range.selectNode(tempDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        try {
            document.execCommand('copy');
            alert('ν¨μΉλ…ΈνΈκ°€ ν΄λ¦½λ³΄λ“μ— λ³µμ‚¬λμ—μµλ‹λ‹¤.');
        } catch (err) {
            console.error('ν΄λ¦½λ³΄λ“ λ³µμ‚¬ μ‹¤ν¨:', err);
            alert('ν΄λ¦½λ³΄λ“ λ³µμ‚¬μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
        }
        
        // μ„μ‹ μ”μ† μ κ±°
        selection.removeAllRanges();
        document.body.removeChild(tempDiv);
    });
}
</script>